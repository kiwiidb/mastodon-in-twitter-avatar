package handler

import (
	"encoding/base64"
	"fmt"
	"image"
	"image/color"
	"image/draw"
	_ "image/jpeg"
	"image/png"
	"net/http"
	"strings"

	"github.com/dghubble/go-twitter/twitter"
	"github.com/koding/multiconfig"
	"golang.org/x/oauth2"
	"golang.org/x/oauth2/clientcredentials"
)

var mastodon = ` data:image/jpeg;base64,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`
var twitterClient *twitter.Client

type Config struct {
	ClientID     string
	ClientSecret string
	TokenUrl     string `default:"https://api.twitter.com/oauth2/token"`
}

func init() {
	//load in conf from env vars
	conf := &Config{}
	multiconfig.New().Load(&conf)

	//construct twitter client
	config := &clientcredentials.Config{
		ClientID:     conf.ClientID,
		ClientSecret: conf.ClientSecret,
		TokenURL:     conf.TokenUrl,
	}

	httpClient := config.Client(oauth2.NoContext)
	twitterClient = twitter.NewClient(httpClient)
}

func Handler(w http.ResponseWriter, r *http.Request) {
	usernames, ok := r.URL.Query()["username"]
	if !ok || len(usernames[0]) < 1 {
		w.WriteHeader(http.StatusBadRequest)
		fmt.Fprintf(w, "Add your twitter username as a query parameter: https://mastodon-in-twitter-avatar.vercel.app/api/mastodon?username=<YOUR_TWITTER_USERNAME>")
		return
	}
	usr, _, err := twitterClient.Users.Show(&twitter.UserShowParams{
		ScreenName: usernames[0],
	})
	if err != nil {
		w.WriteHeader(http.StatusInternalServerError)
		fmt.Fprintf(w, "Oops")
		return
	}
	avatar := strings.Replace(usr.ProfileImageURLHttps, "_normal", "", 1)
	result, err := combineImages(avatar)
	if err != nil {
		w.WriteHeader(http.StatusInternalServerError)
		fmt.Fprintf(w, "Oops")
		return
	}
	err = png.Encode(w, result)
	if err != nil {
		fmt.Println(err)
	}
}

type ImageLayer struct {
	Image image.Image
	XPos  int
	YPos  int
}

func combineImages(imageUrl string) (result *image.RGBA, err error) {

	resp, err := http.Get(imageUrl)
	if err != nil {
		return nil, err
	}
	avatarImg, _, err := image.Decode(resp.Body)
	if err != nil {
		return nil, err
	}
	i := strings.Index(mastodon, ",")
	if i < 0 {
		return nil, err
	}
	// pass reader to NewDecoder
	dec := base64.NewDecoder(base64.StdEncoding, strings.NewReader(mastodon[i+1:]))
	mastodonImg, _, err := image.Decode(dec)
	if err != nil {
		return nil, err
	}
	//create image's background
	bgImg := image.NewRGBA(image.Rect(0, 0, avatarImg.Bounds().Dx(), avatarImg.Bounds().Dy()))

	//set the background color
	draw.Draw(bgImg, bgImg.Bounds(), &image.Uniform{color.Opaque}, image.ZP, draw.Src)

	//looping image layer, higher array index = upper layer
	for _, img := range []ImageLayer{
		{
			Image: avatarImg,
			XPos:  0,
			YPos:  0,
		},
		{
			Image: mastodonImg,
			XPos:  avatarImg.Bounds().Dx() - mastodonImg.Bounds().Dx(),
			YPos:  avatarImg.Bounds().Dy() - mastodonImg.Bounds().Dy(),
		},
	} {
		//set image offset
		offset := image.Pt(img.XPos, img.YPos)

		//combine the image
		draw.Draw(bgImg, img.Image.Bounds().Add(offset), img.Image, image.ZP, draw.Over)
	}
	return bgImg, nil

}
